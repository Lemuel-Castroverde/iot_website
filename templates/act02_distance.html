{% extends "base.html" %}
{% block content %}
<h2>Distance Sensors</h2>

<div class="card p-3 shadow">
  <h4>
    Sensor 1 Distance: <span id="sensor1">--</span> cm (Max: <span id="sensor1_max">0</span> cm) |
    Sensor 2 Distance: <span id="sensor2">--</span> cm (Max: <span id="sensor2_max">0</span> cm)
  </h4>
  <canvas id="distanceChart" width="800" height="300"></canvas>
</div>

<!-- ðŸ”” Buzzer Indicator -->
<div class="card p-3 shadow mt-3 text-center">
  <h4>Buzzer Status</h4>
  <div id="buzzer" class="buzzer-off" style="font-size: 3rem;">ðŸ””</div>
</div>

<a href="/" class="btn btn-secondary mt-3">â¬… Back to Dashboard</a>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .buzzer-off { color: gray; transition: color 0.3s ease; }
  .buzzer-on  { color: red; animation: buzzer-blink 1s infinite; }
  @keyframes buzzer-blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.3; }
  }
</style>

<script>
let sensor1Max = 0;
let sensor2Max = 0;
let timeCounter = 0;

let sensor1Data = [];
let sensor2Data = [];

const ctx = document.getElementById('distanceChart').getContext('2d');
const distanceChart = new Chart(ctx, {
  type: 'scatter',
  data: { 
    datasets: [
      { label: 'Sensor 1', data: sensor1Data, backgroundColor: 'blue', pointRadius: 5, pointHoverRadius: 7 },
      { label: 'Sensor 2', data: sensor2Data, backgroundColor: 'green', pointRadius: 5, pointHoverRadius: 7 }
    ] 
  },
  options: {
    animation: false, responsive: false, maintainAspectRatio: false,
    scales: { 
      x: { type: 'linear', title: { display: true, text: 'Time (s)' } }, 
      y: { beginAtZero: true, title: { display: true, text: 'Distance (cm)' } } 
    }
  }
});

// --- Buzzer update function ---
function updateBuzzer(s1, s2) {
  const buzzerEl = document.getElementById("buzzer");
  if (s1 > 12 || s2 > 12) {
    buzzerEl.classList.remove("buzzer-off");
    buzzerEl.classList.add("buzzer-on");
    buzzerEl.title = "Buzzer ON: Distance > 12cm";
  } else {
    buzzerEl.classList.remove("buzzer-on");
    buzzerEl.classList.add("buzzer-off");
    buzzerEl.title = "Buzzer OFF";
  }
}

function fetchData() {
  fetch("/get_distance")
    .then(res => res.json())
    .then(data => {
      timeCounter++;

      // Update displayed values
      document.getElementById("sensor1").textContent = data.sensor1;
      document.getElementById("sensor2").textContent = data.sensor2;

      // Track max values
      if (data.sensor1 > sensor1Max) sensor1Max = data.sensor1;
      if (data.sensor2 > sensor2Max) sensor2Max = data.sensor2;
      document.getElementById("sensor1_max").textContent = sensor1Max;
      document.getElementById("sensor2_max").textContent = sensor2Max;

      // Push new data
      sensor1Data.push({ x: timeCounter, y: data.sensor1 });
      sensor2Data.push({ x: timeCounter, y: data.sensor2 });

      if (sensor1Data.length > 60) sensor1Data.shift();
      if (sensor2Data.length > 60) sensor2Data.shift();

      distanceChart.update();

      // Update buzzer
      updateBuzzer(data.sensor1, data.sensor2);
    });
}

setInterval(fetchData, 1000);
</script>
{% endblock %}
