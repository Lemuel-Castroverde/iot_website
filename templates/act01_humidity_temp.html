{% extends "base.html" %}
{% block content %}
<h2>Humidity & Temperature</h2>

<div class="card p-3 shadow">
  <h4>Temperature: <span id="temp">--</span> °C</h4>
  <h4>Humidity: <span id="hum">--</span> %</h4>
  <div style="height:400px;">
    <canvas id="tempHumChart"></canvas>
  </div>
</div>

<a href="/" class="btn btn-secondary mt-3">⬅ Back to Dashboard</a>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let tempData = [];
let humData = [];

const ctx = document.getElementById('tempHumChart').getContext('2d');
const tempHumChart = new Chart(ctx, {
  type: 'line',
  data: {
    datasets: [
      {
        label: 'Temperature (°C)',
        data: tempData,
        borderColor: 'red',
        backgroundColor: 'rgba(255, 99, 132, 0.3)',
        fill: true,
        tension: 0.3,
        pointRadius: 3,
        pointHoverRadius: 5
      },
      {
        label: 'Humidity (%)',
        data: humData,
        borderColor: 'blue',
        backgroundColor: 'rgba(54, 162, 235, 0.3)',
        fill: true,
        tension: 0.3,
        pointRadius: 3,
        pointHoverRadius: 5
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    scales: {
      x: {
        type: 'linear',
        min: 0,
        max: 60,
        title: { display: true, text: 'Time (s)' }
      },
      y: {
        beginAtZero: true,
        title: { display: true, text: 'Values' }
      }
    }
  }
});

function fetchData() {
  fetch("/get_temp_humidity")
    .then(res => res.json())
    .then(data => {
      // shift all existing points left by 1s
      tempData.forEach(p => p.x--);
      humData.forEach(p => p.x--);

      // remove points that fall off the left (< 0)
      while (tempData.length && tempData[0].x < 0) tempData.shift();
      while (humData.length && humData[0].x < 0) humData.shift();

      // add new point at right edge (x = 60)
      tempData.push({ x: 60, y: data.temperature });
      humData.push({ x: 60, y: data.humidity });

      // update labels
      document.getElementById("temp").textContent = data.temperature;
      document.getElementById("hum").textContent = data.humidity;

      tempHumChart.update();
    });
}

setInterval(fetchData, 1000);
</script>
{% endblock %}
