{% extends "base.html" %}
{% block content %}
<h2>Distance Sensors</h2>
<div class="card p-3 shadow">
  <h4>Sensor 1 Distance: <span id="sensor1">--</span> cm (Max: <span id="sensor1_max">0</span> cm)</h4>
  <h4>Sensor 2 Distance: <span id="sensor2">--</span> cm (Max: <span id="sensor2_max">0</span> cm)</h4>

  <canvas id="distanceChart" style="width:100%; height:400px;"></canvas>
</div>

<a href="/" class="btn btn-secondary mt-3">⬅ Back to Dashboard</a>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let sensor1Max = 0;
let sensor2Max = 0;
let labels = [];
let sensor1Data = [];
let sensor2Data = [];

const ctx = document.getElementById('distanceChart').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: labels,
    datasets: [
      {
        label: 'Sensor 1',
        borderColor: 'blue',
        backgroundColor: 'rgba(0,0,255,0.1)',
        data: sensor1Data,
        fill: true,
        tension: 0.3
      },
      {
        label: 'Sensor 2',
        borderColor: 'green',
        backgroundColor: 'rgba(0,255,0,0.1)',
        data: sensor2Data,
        fill: true,
        tension: 0.3
      }
    ]
  },
  options: {
    animation: false,
    responsive: true,
    scales: {
      x: {
        title: { display: true, text: 'Time (s)' }
      },
      y: {
        beginAtZero: true,
        title: { display: true, text: 'Distance (cm)' }
      }
    }
  }
});

function fetchData() {
  fetch("/get_distance")
    .then(res => res.json())
    .then(data => {
      const t = new Date().toLocaleTimeString();

      // Update displayed values
      document.getElementById("sensor1").textContent = data.sensor1;
      document.getElementById("sensor2").textContent = data.sensor2;

      // Track max values
      if (data.sensor1 > sensor1Max) sensor1Max = data.sensor1;
      if (data.sensor2 > sensor2Max) sensor2Max = data.sensor2;
      document.getElementById("sensor1_max").textContent = sensor1Max;
      document.getElementById("sensor2_max").textContent = sensor2Max;

      // Update chart data
      labels.push(t);
      sensor1Data.push(data.sensor1);
      sensor2Data.push(data.sensor2);

      // Keep only 60 points (≈1 min if 1s interval)
      if (labels.length > 60) {
        labels.shift();
        sensor1Data.shift();
        sensor2Data.shift();
      }

      chart.update();
    });
}
setInterval(fetchData, 1000); // 1s interval
</script>
{% endblock %}
