{% extends "base.html" %}
{% block content %}
<h2>Ultrasonic Sensor Dashboard</h2>

<div class="card p-3 shadow">
  <h4>Sensor 1 & Sensor 2 (Live)</h4>
  <canvas id="sensorChart" width="800" height="300"></canvas>
</div>

<!-- ðŸ”” Buzzer Indicator -->
<div class="card p-3 shadow mt-3 text-center">
  <h4>Buzzer Status</h4>
  <div id="buzzerIcon" style="font-size: 4rem;">ðŸ”•</div>
</div>

<a href="/" class="btn btn-secondary mt-3">â¬… Back to Dashboard</a>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  #buzzerIcon {
    font-size: 70px;
    margin: 20px;
    transition: transform 0.3s ease, color 0.3s ease;
    color: #777;
  }
  #buzzerIcon.active {
    color: #ff4040;
    transform: scale(1.2);
  }
</style>

<script>
const ctx = document.getElementById("sensorChart").getContext("2d");

const sensorChart = new Chart(ctx, {
  type: "scatter",
  data: {
    datasets: [
      {
        label: "Sensor 1",
        borderColor: "#4da6ff",
        backgroundColor: "#4da6ff",
        data: [],
        showLine: false,
        pointRadius: 6,
        pointHoverRadius: 8
      },
      {
        label: "Sensor 2",
        borderColor: "#4dff88",
        backgroundColor: "#4dff88",
        data: [],
        showLine: false,
        pointRadius: 6,
        pointHoverRadius: 8
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { labels: { color: "#333" } }
    },
    scales: {
      x: {
        type: "category",
        ticks: { color: "#555" },
        grid: { display: false }
      },
      y: {
        beginAtZero: true,
        max: 50,   // keep within 0â€“50 cm
        ticks: { 
          color: "#555",
          callback: function(value) { return value + " cm"; }
        },
        grid: { color: "rgba(0,0,0,0.05)" }
      }
    },
    animation: false
  }
});

function updateData() {
  fetch("/data") // <-- Flask endpoint from your Pi
    .then(response => response.json())
    .then(data => {
      const now = new Date().toLocaleTimeString();

      // Add new data points
      sensorChart.data.datasets[0].data.push({x: now, y: data.sensor1});
      sensorChart.data.datasets[1].data.push({x: now, y: data.sensor2});

      // Keep only last 20 points
      if (sensorChart.data.datasets[0].data.length > 20) {
        sensorChart.data.datasets[0].data.shift();
        sensorChart.data.datasets[1].data.shift();
      }

      sensorChart.update();

      // Update buzzer icon
      const buzzerIcon = document.getElementById("buzzerIcon");
      if (data.buzzer) {
        buzzerIcon.textContent = "ðŸ””"; 
        buzzerIcon.classList.add("active");
      } else {
        buzzerIcon.textContent = "ðŸ”•"; 
        buzzerIcon.classList.remove("active");
      }
    });
}

setInterval(updateData, 1000);
</script>
{% endblock %}
